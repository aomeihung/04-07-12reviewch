import React, { useState, useEffect, useMemo } from 'react';

// --- 自定義內聯 SVG 圖示 (取代 lucide-react 以提高嵌入相容性) ---
const Icons = {
  Star: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>,
  Sparkles: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/><path d="M5 3v4"/><path d="M19 17v4"/><path d="M3 5h4"/><path d="M17 19h4"/></svg>,
  ChevronLeft: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m15 18-6-6 6-6"/></svg>,
  Rocket: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M4.5 16.5c-1.5 1.26-2 5-2 5s3.74-.5 5-2c.71-.84.7-2.13-.09-2.91a2.18 2.18 0 0 0-2.91-.09z"/><path d="m12 15-3-3a22 22 0 0 1 2-3.95A12.88 12.88 0 0 1 22 2c0 2.72-.78 7.5-6 11a22.35 22.35 0 0 1-4 2z"/><path d="M9 12H4s.55-3.03 2-5c1.62-2.2 5-3 5-3"/><path d="M12 15v5s3.03-.55 5-2c2.2-1.62 3-5 3-5"/></svg>,
  BookOpen: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>,
  Heart: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"/></svg>,
  ThumbsUp: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M7 10v12"/><path d="M15 5.88 14 10h5.83a2 2 0 0 1 1.92 2.56l-2.33 8A2 2 0 0 1 17.5 22H4a2 2 0 0 1-2-2v-8a2 2 0 0 1 2-2h2.76a2 2 0 0 0 1.79-1.11L12 2h0a3.13 3.13 0 0 1 3 3.88Z"/></svg>,
  Trophy: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"/><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"/><path d="M4 22h16"/><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"/><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"/><path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"/></svg>,
  Target: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></svg>,
  Medal: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M7.21 15 2.66 7.14a2 2 0 0 1 .13-2.2L4.4 2.8A2 2 0 0 1 6 2h12a2 2 0 0 1 1.6.8l1.6 2.14a2 2 0 0 1 .14 2.2L16.79 15"/><circle cx="12" cy="15" r="5"/><path d="M12 18v-6"/><path d="m9 15 3 3 3-3"/></svg>,
  Award: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="8" r="6"/><path d="M15.477 12.89 17 22l-5-3-5 3 1.523-9.11"/></svg>,
  Zap: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M4 14a1 1 0 0 1-.78-1.63l9.9-10.2a.5.5 0 0 1 .86.46l-1.92 6.02A1 1 0 0 0 13 10h7a1 1 0 0 1 .78 1.63l-9.9 10.2a.5.5 0 0 1-.86-.46l1.92-6.02A1 1 0 0 0 11 14H4Z"/></svg>
};

// --- 全課程精準校準數據 ---
const LESSONS_DATA = {
  "第七課": {
    color: "from-orange-400 to-orange-500",
    themeColor: "#f97316",
    chars: "衣胖針簡單聰明臣敢東西直棒街裳慌滿眼哪思".split(""),
    phrases: [
      { text: "胖子國王", target: "胖" }, { text: "漂亮衣裳", target: "裳" }, { text: "神奇衣裳", target: "衣" },
      { text: "針線", target: "針" }, { text: "簡單", target: "簡" }, { text: "簡單", target: "單" },
      { text: "聰明", target: "聰" }, { text: "聰明", target: "明" }, { text: "不敢", target: "敢" },
      { text: "東西", target: "東" }, { text: "東西", target: "西" }, { text: "大臣", target: "臣" },
      { text: "慌張", target: "慌" }, { text: "好棒", target: "棒" }, { text: "滿街", target: "滿" },
      { text: "滿街", target: "街" }, { text: "雙眼", target: "眼" }, { text: "哪裡", target: "哪" },
      { text: "思想", target: "思" }, { text: "一直", target: "直" }
    ],
    blacklist: { "聰明": ["明", "慧"], "簡單": ["單"], "大臣": ["臣"], "滿街": ["街"] }
  },
  "第八課": {
    color: "from-blue-400 to-blue-500",
    themeColor: "#3b82f6",
    chars: "渴烏喝瓶法森林物旅行午裝許石難忘哈但熊鴉".split(""),
    phrases: [
      { text: "口渴", target: "渴" }, { text: "烏鴉", target: "烏" }, { text: "烏鴉", target: "鴉" },
      { text: "喝水", target: "喝" }, { text: "瓶子", target: "瓶" }, { text: "方法", target: "法" },
      { text: "森林", target: "森" }, { text: "森林", target: "林" }, { text: "動物", target: "物" },
      { text: "旅行", target: "旅" }, { text: "旅行", target: "行" }, { text: "中午", target: "午" },
      { text: "裝水", target: "裝" }, { text: "許多", target: "許" }, { text: "石頭", target: "石" },
      { text: "難道", target: "難" }, { text: "忘記", target: "忘" }, { text: "哈哈", target: "哈" },
      { text: "但是", target: "但" }, { text: "北極熊", target: "熊" }
    ],
    blacklist: { "烏鴉": ["鴉", "黑"], "口渴": ["喝"], "喝水": ["渴"], "森林": ["林"] }
  },
  "第九課": {
    color: "from-green-400 to-green-500",
    themeColor: "#22c55e",
    chars: "象操粗腿柱砍幾部搖沖首牽沉少沿然紀竟曹秤".split(""),
    phrases: [
      { text: "曹操", target: "曹" }, { text: "曹操", target: "操" }, { text: "大象", target: "象" },
      { text: "秤重", target: "秤" }, { text: "砍樹", target: "砍" }, { text: "粗大", target: "粗" },
      { text: "大腿", target: "腿" }, { text: "柱子", target: "柱" }, { text: "幾個", target: "幾" },
      { text: "部分", target: "部" }, { text: "搖著", target: "搖" }, { text: "沖水", target: "沖" },
      { text: "首先", target: "首" }, { text: "牽手", target: "牽" }, { text: "下沉", target: "沉" },
      { text: "多少", target: "少" }, { text: "沿著", target: "沿" }, { text: "然後", target: "然" },
      { text: "年紀", target: "紀" }, { text: "竟然", target: "竟" }
    ],
    blacklist: { "大象": ["腿"], "大腿": ["象"], "曹操": ["象", "腿"], "搖著": ["沿", "砍", "牽", "沖"], "沿著": ["搖", "砍", "牽", "沖"] }
  },
  "第十課": {
    color: "from-purple-400 to-purple-500",
    themeColor: "#a855f7",
    chars: "雪梨夜卻冷冬臺季相反煙火待雖春貨期飯灣綻".split(""),
    phrases: [
      { text: "雪梨", target: "雪" }, { text: "雪梨", target: "梨" }, { text: "卻是", target: "卻" },
      { text: "午夜", target: "夜" }, { text: "冬天", target: "冬" }, { text: "冷風", target: "冷" },
      { text: "季節", target: "季" }, { text: "臺灣", target: "臺" },
      { text: "相反", target: "相" }, { text: "相反", target: "反" }, { text: "期待", target: "待" },
      { text: "期待", target: "期" }, { text: "煙火", target: "煙" }, { text: "煙火", target: "火" },
      { text: "綻放", target: "綻" }, { text: "春節", target: "春" }, { text: "年貨", target: "貨" },
      { text: "雖然", target: "雖" }, { text: "吃飯", target: "飯" }, { text: "臺灣", target: "灣" }
    ],
    blacklist: { "臺灣": ["灣"], "相反": ["反"], "期待": ["期", "待"], "雪梨": ["梨"], "煙火": ["火"] }
  },
  "第十一課": {
    color: "from-pink-400 to-pink-500",
    themeColor: "#ec4899",
    chars: "皮具飛者洋寒北嘴伸飽沙急服站翅膀充念戴扁".split(""),
    phrases: [
      { text: "調皮", target: "皮" }, { text: "舞者", target: "者" }, { text: "戴著", target: "戴" },
      { text: "面具", target: "具" }, { text: "思念", target: "念" }, { text: "寒冷", target: "寒" },
      { text: "北方", target: "北" }, { text: "翅膀", target: "翅" }, { text: "翅膀", target: "膀" },
      { text: "飛行", target: "飛" }, { text: "海洋", target: "洋" }, { text: "黑扁", target: "扁" },
      { text: "大嘴", target: "嘴" }, { text: "好飽", target: "飽" }, { text: "站在", target: "站" },
      { text: "伸進", target: "伸" }, { text: "著急", target: "急" }, { text: "衣服", target: "服" },
      { text: "充滿", target: "充" }, { text: "沙子", target: "沙" }
    ],
    blacklist: { 
      "翅膀": ["膀"], 
      "面具": ["皮"], 
      "戴著": ["急", "站"],
      "飛行": ["急"] 
    }
  },
  "第十二課": {
    color: "from-cyan-400 to-cyan-500",
    themeColor: "#06b6d4",
    chars: "灰涼牠鼓絡欣發居冒冰圍咪幸團聚愉鍋妙聊".split(""),
    phrases: [
      { text: "美妙", target: "妙" }, { text: "幸福", target: "幸" }, { text: "愉快", target: "愉" },
      { text: "欣喜", target: "欣" }, { text: "團聚", target: "團" }, { text: "團聚", target: "聚" },
      { text: "熱絡", target: "絡" }, { text: "聊天", target: "聊" }, { text: "發現", target: "發" },
      { text: "居然", target: "居" }, { text: "冒煙", target: "冒" }, { text: "火鍋", target: "鍋" },
      { text: "灰色", target: "灰" }, { text: "包圍", target: "圍" }, { text: "冰涼", target: "冰" },
      { text: "冰涼", target: "涼" }, { text: "貓咪", target: "咪" }, { text: "牠們", target: "牠" },
      { text: "圓鼓鼓", target: "鼓" }
    ],
    blacklist: { "團聚": ["聚", "圓"], "冰涼": ["涼", "水"], "熱絡": ["聊"] }
  }
};

const DollCollection = [
  () => (
    <svg viewBox="0 0 100 100" className="w-full h-full drop-shadow-lg">
      <circle cx="50" cy="55" r="35" fill="#FFB347" />
      <path d="M25 35 L15 15 L40 25 Z" fill="#FFB347" />
      <path d="M75 35 L85 15 L60 25 Z" fill="#FFB347" />
      <circle cx="40" cy="50" r="3" fill="#333" />
      <circle cx="60" cy="50" r="3" fill="#333" />
      <path d="M45 60 Q50 65 55 60" fill="none" stroke="#333" strokeWidth="2" strokeLinecap="round" />
      <circle cx="35" cy="55" r="5" fill="#FF9999" opacity="0.4" />
      <circle cx="65" cy="55" r="5" fill="#FF9999" opacity="0.4" />
    </svg>
  ),
  () => (
    <svg viewBox="0 0 100 100" className="w-full h-full drop-shadow-lg">
      <circle cx="50" cy="60" r="30" fill="#FFC0CB" />
      <rect x="30" y="10" width="15" height="40" rx="7" fill="#FFC0CB" />
      <rect x="55" y="10" width="15" height="40" rx="7" fill="#FFC0CB" />
      <circle cx="42" cy="58" r="2.5" fill="#333" />
      <circle cx="58" cy="58" r="2.5" fill="#333" />
      <path d="M48 70 Q50 72 52 70" fill="none" stroke="#333" strokeWidth="1.5" />
    </svg>
  ),
  () => (
    <svg viewBox="0 0 100 100" className="w-full h-full drop-shadow-lg">
      <rect x="25" y="30" width="50" height="50" rx="15" fill="#4DB6AC" />
      <circle cx="35" cy="25" r="8" fill="#4DB6AC" />
      <circle cx="65" cy="25" r="8" fill="#4DB6AC" />
      <circle cx="40" cy="50" r="3" fill="white" />
      <circle cx="60" cy="50" r="3" fill="white" />
      <path d="M45 65 h10" stroke="white" strokeWidth="3" strokeLinecap="round" />
    </svg>
  )
];

const App = () => {
  const [view, setView] = useState('home'); 
  const [currentLesson, setCurrentLesson] = useState(null);
  const [questions, setQuestions] = useState([]);
  const [currentIndex, setCurrentIndex] = useState(0);
  const [score, setScore] = useState(0);
  const [combo, setCombo] = useState(0);
  const [selectedOption, setSelectedOption] = useState(null);
  const [isCorrect, setIsCorrect] = useState(null);
  const [dollIndex, setDollIndex] = useState(0);

  const startQuiz = (lessonKey) => {
    const lesson = LESSONS_DATA[lessonKey];
    const generatedQuestions = lesson.phrases.map(phrase => {
      const correctAnswer = phrase.target;
      const phraseBlacklist = (lesson.blacklist && lesson.blacklist[phrase.text]) || [];
      
      const distractors = lesson.chars.filter(char => {
        if (char === correctAnswer) return false;
        if (phrase.text.includes(char)) return false;
        if (phraseBlacklist.includes(char)) return false;
        return true;
      })
      .sort(() => Math.random() - 0.5)
      .slice(0, 2);

      const options = [correctAnswer, ...distractors].sort(() => Math.random() - 0.5);
      return {
        display: phrase.text.replace(correctAnswer, "（　）"),
        answer: correctAnswer,
        options
      };
    }).sort(() => Math.random() - 0.5);

    setQuestions(generatedQuestions);
    setCurrentLesson(lessonKey);
    setCurrentIndex(0);
    setScore(0);
    setCombo(0);
    setSelectedOption(null);
    setIsCorrect(null);
    setView('quiz');
  };

  const handleOptionClick = (option) => {
    if (selectedOption !== null) return;
    const correct = option === questions[currentIndex].answer;
    setSelectedOption(option);
    setIsCorrect(correct);

    if (correct) {
      setScore(prev => prev + 1);
      setCombo(prev => prev + 1);
      setTimeout(() => {
        if (currentIndex < questions.length - 1) {
          setCurrentIndex(prev => prev + 1);
          setSelectedOption(null);
          setIsCorrect(null);
        } else {
          setDollIndex(Math.floor(Math.random() * DollCollection.length));
          setView('result');
        }
      }, 800); 
    } else {
      setCombo(0);
      setTimeout(() => {
        setSelectedOption(null);
        setIsCorrect(null);
      }, 1000);
    }
  };

  const currentTheme = useMemo(() => {
    return currentLesson ? LESSONS_DATA[currentLesson] : { color: "from-orange-400 to-orange-500", themeColor: "#f97316" };
  }, [currentLesson]);

  return (
    <div className="min-h-screen bg-[#FDFCF0] flex flex-col items-center p-2 sm:p-4 md:p-6 font-sans text-slate-700 select-none overflow-x-hidden touch-manipulation">
      <style>{`
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-8px); } 75% { transform: translateX(8px); } }
        @keyframes rainbow { 0% { filter: hue-rotate(0deg); } 100% { filter: hue-rotate(360deg); } }
        @keyframes float { 0% { transform: translateY(0px); } 50% { transform: translateY(-10px); } 100% { transform: translateY(0px); } }
        @keyframes pop { 0% { transform: scale(0.8); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        @keyframes bounce-subtle { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }
        @keyframes spin-slow { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .text-glow { text-shadow: 0 0 15px rgba(255, 255, 255, 0.8); }
        .animate-spin-slow { animation: spin-slow 8s linear infinite; }
        /* 防止手機點擊時出現藍色底框 */
        * { -webkit-tap-highlight-color: transparent; }
      `}</style>
      
      {/* Header - 手機端微調間距 */}
      <div className="w-full max-w-2xl mb-4 sm:mb-6 flex items-center justify-between z-10 px-2">
        <div className="flex items-center gap-2 sm:gap-3">
          <div className="bg-orange-500 p-1.5 sm:p-2.5 rounded-xl sm:rounded-2xl shadow-lg border-2 border-white animate-[float_4s_infinite_ease-in-out]">
            <Icons.Sparkles />
          </div>
          <div>
            <h1 className="text-xl sm:text-2xl font-black text-orange-600 tracking-tight">國字小偵探</h1>
            <p className="text-[9px] sm:text-[10px] font-bold text-orange-400 uppercase tracking-widest hidden sm:block">Character Detective Pro</p>
          </div>
        </div>
        {view !== 'home' && (
          <button 
            onClick={() => setView('home')} 
            className="group flex items-center gap-1 sm:gap-2 px-3 py-2 sm:px-4 sm:py-2.5 bg-white rounded-xl sm:rounded-2xl shadow-sm border border-slate-100 transition-all active:scale-90 hover:shadow-md text-slate-500 font-bold text-sm sm:text-base"
          >
            <div className="text-orange-500 group-hover:-translate-x-1 transition-transform">
              <Icons.ChevronLeft />
            </div>
            返回
          </button>
        )}
      </div>

      {/* Main Card - 適應不同螢幕寬度與圓角 */}
      <div className="w-full max-w-4xl bg-white rounded-[2rem] sm:rounded-[3rem] shadow-2xl shadow-orange-100/50 overflow-hidden p-4 sm:p-8 md:p-10 border-4 border-white flex-1 flex flex-col relative transition-all duration-500">
        
        {/* Home View - 網格自適應佈局 */}
        {view === 'home' && (
          <div className="flex-1 flex flex-col items-center justify-center space-y-6 sm:space-y-12 animate-[pop_0.5s_ease-out] py-4">
            <div className="text-center space-y-3 sm:space-y-4">
              <div className="inline-block relative px-4">
                <h2 className="text-3xl sm:text-4xl md:text-6xl font-black text-slate-800 leading-tight">
                  生字任務挑戰<br/>
                  <span className="text-transparent bg-clip-text bg-gradient-to-r from-orange-500 to-yellow-500">準備好破案了嗎？</span>
                </h2>
                <div className="absolute -top-6 -right-2 sm:-right-8 animate-bounce text-yellow-400 scale-75 sm:scale-100">
                  <Icons.Medal />
                </div>
              </div>
              <div className="flex items-center justify-center gap-2 text-green-600 font-bold bg-green-50 px-4 py-2 sm:px-8 sm:py-3 rounded-full border border-green-100 shadow-sm animate-[bounce-subtle_2s_infinite] text-xs sm:text-sm">
                <Icons.ThumbsUp />
                <span>每一題都是進步的機會，加油！</span>
              </div>
            </div>

            <div className="grid grid-cols-2 lg:grid-cols-3 gap-3 sm:gap-6 w-full max-w-3xl">
              {Object.keys(LESSONS_DATA).map(lessonKey => (
                <button 
                  key={lessonKey} 
                  onClick={() => startQuiz(lessonKey)} 
                  className={`group relative flex flex-col items-center justify-center p-4 sm:p-8 bg-gradient-to-br ${LESSONS_DATA[lessonKey].color} hover:scale-105 active:scale-95 transition-all rounded-[1.5rem] sm:rounded-[2.5rem] shadow-xl text-white h-32 sm:h-44 overflow-hidden border-b-4 sm:border-b-8 border-black/10`}
                >
                  <span className="font-black text-xl sm:text-3xl mb-1 relative z-10">{lessonKey}</span>
                  <div className="h-0.5 sm:h-1 w-8 sm:w-12 bg-white/40 my-1.5 sm:my-3 rounded-full relative z-10"></div>
                  <span className="text-[10px] sm:text-sm font-bold opacity-90 relative z-10">{LESSONS_DATA[lessonKey].phrases.length} 個任務</span>
                  <div className="absolute -bottom-2 -right-2 sm:-bottom-4 sm:-right-4 opacity-30 group-hover:scale-125 transition-transform scale-75 sm:scale-100">
                    <Icons.Star />
                  </div>
                </button>
              ))}
            </div>
          </div>
        )}

        {/* Quiz View - 針對行動版文字縮小與間距壓縮 */}
        {view === 'quiz' && (
          <div className="flex-1 flex flex-col space-y-4 sm:space-y-8 animate-[pop_0.4s_ease-out]">
            <div className="flex flex-col md:flex-row justify-between items-center gap-3 sm:gap-4 px-1">
              <div className="flex items-center gap-2 sm:gap-3 w-full justify-between sm:justify-start">
                <span className={`px-5 py-2 sm:px-8 sm:py-3 rounded-full text-white font-black text-base sm:text-xl bg-gradient-to-r ${currentTheme.color} shadow-lg border-b-2 sm:border-b-4 border-black/10`}>
                  {currentLesson}
                </span>
                {combo > 1 && (
                  <div className="flex items-center gap-1 bg-yellow-400 text-yellow-900 px-3 py-1.5 sm:px-4 sm:py-2 rounded-full font-black animate-bounce shadow-md text-xs sm:text-sm">
                    <Icons.Zap />
                    連擊 {combo}
                  </div>
                )}
              </div>
              
              <div className="flex flex-col items-end gap-1.5 sm:gap-2 w-full md:w-auto">
                 <div className="flex justify-between w-full md:w-auto gap-2 sm:gap-4">
                   <div className="bg-slate-100 px-3 py-1.5 sm:px-5 sm:py-2 rounded-xl sm:rounded-2xl text-slate-500 font-bold text-[10px] sm:text-sm border border-slate-200">
                    任務 <span className="text-slate-800 font-black ml-1">{currentIndex + 1} / {questions.length}</span>
                   </div>
                   <div className="bg-orange-50 px-3 py-1.5 sm:px-5 sm:py-2 rounded-xl sm:rounded-2xl text-orange-600 font-bold text-[10px] sm:text-sm border border-orange-100">
                    分數 <span className="font-black ml-1 text-orange-700">{score * 10}</span>
                   </div>
                 </div>
                 <div className="w-full md:w-64 h-2 sm:h-3 bg-slate-100 rounded-full overflow-hidden border border-slate-200 shadow-inner p-0.5">
                   <div 
                     className="h-full bg-gradient-to-r from-orange-400 to-yellow-400 rounded-full transition-all duration-500 ease-out" 
                     style={{ width: `${((currentIndex + 1) / questions.length) * 100}%` }}
                   />
                 </div>
              </div>
            </div>

            <div className="flex-1 flex flex-col items-center justify-center bg-slate-50 rounded-[1.5rem] sm:rounded-[3rem] border-2 sm:border-4 border-dashed border-slate-200 py-6 sm:py-12 px-4 shadow-inner relative overflow-hidden group">
              <div className="absolute top-4 left-4 text-slate-200 opacity-50 sm:opacity-100 scale-75 sm:scale-100 transition-transform duration-500">
                <Icons.Target />
              </div>
              <div className="absolute bottom-4 right-4 text-slate-200 opacity-30 sm:opacity-50 scale-100 sm:scale-150">
                <Icons.BookOpen />
              </div>
              
              <span className="text-slate-400 font-bold mb-4 sm:mb-8 text-sm sm:text-xl tracking-widest uppercase">偵察目標：</span>
              <div className="relative w-full text-center">
                <span className={`text-5xl sm:text-7xl md:text-9xl font-black tracking-[0.1em] sm:tracking-[0.2em] transition-all duration-300 ${selectedOption && isCorrect ? 'text-orange-500 animate-[rainbow_1.5s_linear_infinite] scale-105 inline-block' : 'text-slate-700'}`}>
                  {selectedOption && isCorrect ? questions[currentIndex].display.replace("（　）", questions[currentIndex].answer) : questions[currentIndex].display}
                </span>
              </div>
            </div>

            {/* 選項按鈕 - 手機版調整高度與文字 */}
            <div className="grid grid-cols-3 gap-2 sm:gap-4 md:gap-8">
              {questions[currentIndex].options.map((option, idx) => {
                let statusClass = "bg-white text-slate-700 border-2 border-slate-100 hover:border-orange-300 shadow-md active:translate-y-1";
                if (selectedOption === option) {
                  statusClass = isCorrect ? "bg-green-500 text-white border-green-600 scale-105 shadow-green-200" : "bg-pink-500 text-white animate-[shake_0.4s] border-pink-600 shadow-pink-200";
                } else if (selectedOption !== null && option === questions[currentIndex].answer) {
                  statusClass = "bg-white text-green-600 border-2 border-green-400 border-dashed opacity-80";
                }
                
                return (
                  <button 
                    key={idx} 
                    onClick={() => handleOptionClick(option)} 
                    disabled={selectedOption !== null} 
                    className={`h-24 sm:h-40 md:h-52 rounded-[1.2rem] sm:rounded-[2.5rem] text-4xl sm:text-6xl md:text-8xl font-black transition-all flex items-center justify-center ${statusClass}`}
                  >
                    <span className={selectedOption === option && isCorrect ? "animate-bounce" : ""}>{option}</span>
                  </button>
                );
              })}
            </div>
          </div>
        )}

        {/* Result View - 行動版適應 */}
        {view === 'result' && (
          <div className="flex-1 flex flex-col items-center justify-center space-y-6 sm:space-y-10 text-center animate-[pop_0.6s_ease-out] py-4">
            <div className="relative">
              <div className="absolute inset-0 bg-yellow-400/30 blur-3xl rounded-full scale-150 animate-pulse" />
              <div className="w-40 h-40 sm:w-64 h-64 bg-white rounded-full flex items-center justify-center border-4 sm:border-8 border-orange-100 shadow-2xl relative z-10 animate-bounce cursor-pointer">
                 <div className="w-28 h-28 sm:w-48 sm:h-48">
                   {DollCollection[dollIndex]()}
                 </div>
              </div>
              <div className="absolute -top-2 -right-2 sm:-top-4 sm:-right-4 bg-yellow-400 text-white p-2 sm:p-4 rounded-full shadow-lg z-20 animate-spin-slow scale-75 sm:scale-100">
                <Icons.Award />
              </div>
            </div>
            
            <div className="space-y-2 sm:space-y-4">
              <h2 className="text-3xl sm:text-5xl md:text-6xl font-black text-slate-800 tracking-tight">任務大成功！</h2>
              <div className="flex flex-col items-center gap-2 sm:gap-3">
                <div className="text-xl sm:text-2xl md:text-3xl font-black text-orange-500 flex items-center gap-2 sm:gap-3">
                  <div className="text-yellow-400 w-6 h-6 sm:w-10 sm:h-10"><Icons.Trophy /></div>
                  精通{currentLesson}！
                  <div className="text-yellow-400 w-6 h-6 sm:w-10 sm:h-10"><Icons.Trophy /></div>
                </div>
                <p className="text-slate-500 font-bold text-sm sm:text-lg bg-slate-100 px-4 py-1.5 sm:px-6 sm:py-2 rounded-full">你是國字界的超級大明星！</p>
              </div>
            </div>

            <div className="flex gap-3 sm:gap-6 w-full flex-row max-w-lg mx-auto">
              <div className="flex-1 bg-gradient-to-br from-green-50 to-green-100 p-4 sm:p-8 rounded-[1.2rem] sm:rounded-[2rem] border-2 border-green-200 shadow-sm">
                  <span className="text-green-600 font-black text-[10px] sm:text-xs block mb-1 uppercase tracking-widest">任務達成</span>
                  <div className="text-2xl sm:text-5xl font-black text-green-700">{questions.length}</div>
              </div>
              <div className="flex-1 bg-gradient-to-br from-orange-50 to-orange-100 p-4 sm:p-8 rounded-[1.2rem] sm:rounded-[2rem] border-2 border-orange-200 shadow-sm">
                  <span className="text-orange-600 font-black text-[10px] sm:text-xs block mb-1 uppercase tracking-widest">總積分</span>
                  <div className="text-2xl sm:text-5xl font-black text-orange-700">{score * 10}</div>
              </div>
            </div>

            <button 
              onClick={() => setView('home')} 
              className="group w-full max-w-xs sm:max-w-sm py-4 sm:py-6 bg-gradient-to-r from-orange-500 to-orange-600 text-white text-lg sm:text-2xl font-black rounded-2xl sm:rounded-3xl shadow-xl hover:scale-105 active:scale-95 transition-all flex items-center justify-center gap-2 sm:gap-4 border-b-4 sm:border-b-8 border-orange-700"
            >
              <div className="group-hover:translate-x-1 group-hover:-translate-y-1 transition-transform scale-75 sm:scale-100">
                <Icons.Rocket />
              </div>
              下一個挑戰！
            </button>
          </div>
        )}
      </div>

      {/* Footer Info - 行動版簡化 */}
      <div className="mt-6 sm:mt-10 text-slate-400 text-[9px] sm:text-[10px] font-black tracking-[0.2em] sm:tracking-[0.3em] flex flex-col items-center gap-2">
        <div className="flex items-center gap-2 sm:gap-4 bg-white/50 px-4 py-1.5 sm:px-6 sm:py-2 rounded-full border border-slate-100">
          <div className="text-pink-300 fill-pink-300 scale-75 sm:scale-100"><Icons.Heart /></div> 
          相信自己，你就是最棒的 
          <div className="text-pink-300 fill-pink-300 scale-75 sm:scale-100"><Icons.Heart /></div>
        </div>
        <span className="opacity-50">國字小偵探 PRO V4.5 (行動優化版)</span>
      </div>
    </div>
  );
};

export default App;
